# Defines buckets on cr-buildbucket.appspot.com, used to schedule builds.
# Some of them are used by CQ to schedule tryjobs.
#
# For schema of this file and documentation, see
# https://chromium.googlesource.com/infra/luci/luci-go/+/master/buildbucket/proto/config/project_config.proto
#
# Please keep this list sorted by bucket name.

acl_sets {
  name: "tryserver"
  acls {
    role: READER
    group: "all"
  }
  # Remove this rule after all Buildbot masters are turned down.
  acls {
    role: WRITER
    group: "service-account-webrtc-master"
  }
  acls {
    role: SCHEDULER
    group: "service-account-cq"
  }
  acls {
    role: SCHEDULER
    group: "project-webrtc-tryjob-access"
  }
  acls {
    role: WRITER
    identity: "luci-migration@appspot.gserviceaccount.com"
  }
}

acl_sets {
  name: "waterfall"
  acls {
    role: READER
    group: "all"
  }
  acls {
    role: SCHEDULER
    identity: "luci-scheduler@appspot.gserviceaccount.com"
  }
  acls {
    role: WRITER
    identity: "luci-migration@appspot.gserviceaccount.com"
  }
}

# Mixins

# os:Linux

builder_mixins {
  name: "linux"
  dimensions: "os:Linux"
  dimensions: "builder_group:Linux-Generic"
  caches {
    path: "builder"
    name: "webrtc_linux"
  }
}

builder_mixins {
  name: "linux_chromium"
  dimensions: "os:Linux"
  dimensions: "builder_group:Linux-Chromium"
  recipe { name: "chromium_trybot" }
}

builder_mixins {
  name: "android"
  dimensions: "os:Linux"
  dimensions: "builder_group:Linux-Android"
  caches {
    path: "builder"
    name: "webrtc_android"
  }
}

builder_mixins {
  name: "android_chromium"
  dimensions: "os:Linux"
  dimensions: "builder_group:Linux-Chromium"
  recipe { name: "chromium_trybot" }
}

builder_mixins {
  name: "presubmit"
  dimensions: "os:Linux"
  dimensions: "builder_group:Presubmit"
  recipe {
    name: "run_presubmit"
    properties: "repo_name:webrtc"
    properties_j: "runhooks:true"
  }
}

# os:Mac

builder_mixins {
  name: "mac"
  dimensions: "os:Mac"
  dimensions: "builder_group:Mac-Generic"
  caches {
    path: "builder"
    name: "webrtc_mac"
  }
}

builder_mixins {
  name: "mac_chromium"
  dimensions: "os:Mac"
  dimensions: "builder_group:Mac-Chromium"
  recipe { name: "chromium_trybot" }
}

builder_mixins {
  name: "ios"
  dimensions: "os:Mac"
  dimensions: "builder_group:Mac-Generic"
  recipe { name: "webrtc/ios" }
  caches {
    path: "builder"
    name: "webrtc_ios"
  }
  caches {
    # Cache for Xcode 9.2 (build version 9C40b) needed for iOS builds.
    name: "xcode_ios_9c40b"
    path: "xcode_ios_9c40b.app"
  }
}

# os:Windows

builder_mixins {
  name: "win"
  dimensions: "os:Windows"
  dimensions: "builder_group:Win-Generic"
  caches {
    path: "builder"
    name: "webrtc_win"
  }
}

builder_mixins {
  name: "win_chromium"
  dimensions: "os:Windows"
  dimensions: "builder_group:Win-Chromium"
  recipe { name: "chromium_trybot" }
}


buckets {
  name: "luci.webrtc.ci"
  acl_sets: "waterfall"

  swarming {
    hostname: "chromium-swarm.appspot.com"
    url_format: "https://luci-milo.appspot.com/swarming/task/{task_id}"
    builder_defaults {
      build_numbers: YES
      dimensions: "cpu:x86-64"
      dimensions: "pool:luci.webrtc.ci"
      luci_migration_host: "luci-migration.appspot.com"
      execution_timeout_secs: 7200  # 2h
      recipe {
        cipd_package: "infra/recipe_bundles/chromium.googlesource.com/chromium/tools/build"
        cipd_version: "refs/heads/master"
        name: "webrtc/standalone"
        # TODO: get rid of the mastername:client.webrtc property.
        properties: "mastername:client.webrtc"
      }
      service_account: "webrtc-ci-builder@chops-service-accounts.iam.gserviceaccount.com"
      swarming_tags: "vpython:native-python-wrapper"
    }

    # Keep builders grouped by OS, then sorted by name.

    # Android

    builders { mixins: "android"  name: "Android32 (M Nexus5X)(dbg)" }
    builders {
      name: "Android32 (M Nexus5X)"
      mixins: "android"
      priority: 29  # Default is 30.
    }
    builders { mixins: "android"  name: "Android64 (M Nexus5X)(dbg)" }
    builders {
      name: "Android64 (M Nexus5X)"
      mixins: "android"
      priority: 29  # Default is 30.
    }
    builders { mixins: "android"  name: "Android32 Builder x86" }
    builders { mixins: "android"  name: "Android32 Builder x86 (dbg)" }
    builders { mixins: "android"  name: "Android64 Builder x64 (dbg)" }
    builders {
      name: "Android32 (more configs)"
      mixins: "android"
      recipe { name: "webrtc/more_configs" }
    }

    # iOS

    builders { mixins: "ios"  name: "iOS32 Debug" }
    builders { mixins: "ios"  name: "iOS32 Release" }
    builders { mixins: "ios"  name: "iOS64 Debug" }
    builders { mixins: "ios"  name: "iOS64 Release" }
    builders { mixins: "ios"  name: "iOS32 Sim Debug (iOS 9.0)" }
    builders { mixins: "ios"  name: "iOS64 Sim Debug (iOS 9.0)" }
    builders { mixins: "ios"  name: "iOS64 Sim Debug (iOS 10.0)" }
    builders {
      name: "iOS API Framework Builder"
      mixins: "ios"
      recipe { name: "webrtc/ios_api_framework" }
      priority: 29  # Default is 30.
    }

    # Linux

    builders { mixins: "linux"  name: "Linux32 Debug" }
    builders { mixins: "linux"  name: "Linux32 Release" }
    builders { mixins: "linux"  name: "Linux64 Debug" }
    builders {
      name: "Linux64 Release"
      mixins: "linux"
      priority: 29  # Default is 30.
    }
    builders { mixins: "linux"  name: "Linux32 Debug (ARM)" }
    builders { mixins: "linux"  name: "Linux32 Release (ARM)" }
    builders { mixins: "linux"  name: "Linux64 Debug (ARM)" }
    builders { mixins: "linux"  name: "Linux64 Release (ARM)" }
    builders { mixins: "linux"  name: "Linux64 Release (GCC)" }
    builders { mixins: "linux"  name: "Linux Asan" }
    builders { mixins: "linux"  name: "Linux MSan" }
    builders { mixins: "linux"  name: "Linux Tsan v2" }
    builders { mixins: "linux"  name: "Linux UBSan" }
    builders { mixins: "linux"  name: "Linux UBSan vptr" }
    builders {
      name: "Linux (more configs)"
      mixins: "linux"
      recipe { name: "webrtc/more_configs" }
    }
    builders {
      name: "Linux64 Release (Libfuzzer)"
      mixins: "linux"
      recipe { name: "webrtc/libfuzzer" }
    }

    # Mac

    builders { mixins: "mac"  name: "Mac64 Debug" }
    builders { mixins: "mac"  name: "Mac64 Release" }
    builders { mixins: "mac"  name: "Mac Asan" }

    # Win

    builders { mixins: "win"  name: "Win32 Debug" }
    builders {
      name: "Win32 Release"
      mixins: "win"
      priority: 29  # Default is 30.
    }
    builders { mixins: "win"  name: "Win64 Debug" }
    builders { mixins: "win"  name: "Win64 Release" }
    builders { mixins: "win"  name: "Win32 Debug (Clang)" }
    builders { mixins: "win"  name: "Win32 Release (Clang)" }
    builders { mixins: "win"  name: "Win64 Debug (Clang)" }
    builders { mixins: "win"  name: "Win64 Release (Clang)" }
    builders { mixins: "win"  name: "Win32 ASan" }
    builders {
      name: "Win (more configs)"
      mixins: "win"
      recipe { name: "webrtc/more_configs" }
    }
  }
}

buckets {
  name: "luci.webrtc.try"
  acl_sets: "tryserver"

  swarming {
    hostname: "chromium-swarm.appspot.com"
    url_format: "https://luci-milo.appspot.com/swarming/task/{task_id}"
    builder_defaults {
      build_numbers: YES
      dimensions: "cpu:x86-64"
      dimensions: "pool:luci.webrtc.try"
      execution_timeout_secs: 7200  # 2h
      recipe {
        cipd_package: "infra/recipe_bundles/chromium.googlesource.com/chromium/tools/build"
        cipd_version: "refs/heads/master"
        name: "webrtc/standalone"
        # TODO: get rid of the mastername:tryserver.webrtc property.
        properties: "mastername:tryserver.webrtc"
      }
      service_account: "webrtc-try-builder@chops-service-accounts.iam.gserviceaccount.com"
      swarming_tags: "vpython:native-python-wrapper"
    }

    # Keep builders grouped by OS, then sorted by name.

    # Android

    builders {
      name: "android_chromium_compile"
      mixins: "android_chromium"
    }
    builders { mixins: "android"  name: "android_compile_dbg" }
    builders { mixins: "android"  name: "android_compile_rel" }
    builders { mixins: "android"  name: "android_compile_arm64_dbg" }
    builders { mixins: "android"  name: "android_compile_arm64_rel" }
    builders { mixins: "android"  name: "android_compile_x86_rel" }
    builders { mixins: "android"  name: "android_compile_x86_dbg" }
    builders { mixins: "android"  name: "android_compile_x64_dbg" }
    builders { mixins: "android"  name: "android_dbg" }
    builders { mixins: "android"  name: "android_rel" }
    builders { mixins: "android"  name: "android_arm64_rel" }
    builders {
      name: "android_more_configs"
      mixins: "android"
      recipe { name: "webrtc/more_configs" }
    }

    # iOS

    builders { mixins: "ios"  name: "ios_dbg" }
    builders { mixins: "ios"  name: "ios_rel" }
    builders { mixins: "ios"  name: "ios_arm64_dbg" }
    builders { mixins: "ios"  name: "ios_arm64_rel" }
    builders { mixins: "ios"  name: "ios32_sim_ios9_dbg" }
    builders { mixins: "ios"  name: "ios64_sim_ios9_dbg" }
    builders { mixins: "ios"  name: "ios64_sim_ios10_dbg" }
    builders {
      name: "ios_api_framework"
      mixins: "ios"
      recipe { name: "webrtc/ios_api_framework" }
    }

    # Linux

    builders {
      name: "linux_chromium_compile"
      mixins: "linux_chromium"
    }
    builders { mixins: "linux"  name: "linux_compile_dbg" }
    builders { mixins: "linux"  name: "linux_compile_rel" }
    builders { mixins: "linux"  name: "linux_dbg" }
    builders { mixins: "linux"  name: "linux_rel" }
    builders { mixins: "linux"  name: "linux_arm64_dbg" }
    builders { mixins: "linux"  name: "linux_arm64_rel" }
    builders { mixins: "linux"  name: "linux32_dbg" }
    builders { mixins: "linux"  name: "linux32_rel" }
    builders { mixins: "linux"  name: "linux32_arm_dbg" }
    builders { mixins: "linux"  name: "linux32_arm_rel" }
    builders { mixins: "linux"  name: "linux_gcc_rel" }
    builders { mixins: "linux"  name: "linux_msan" }
    builders { mixins: "linux"  name: "linux_tsan2" }
    builders { mixins: "linux"  name: "linux_asan" }
    builders { mixins: "linux"  name: "linux_ubsan" }
    builders { mixins: "linux"  name: "linux_ubsan_vptr" }
    builders {
      name: "linux_more_configs"
      mixins: "linux"
      recipe { name: "webrtc/more_configs" }
    }
    builders {
      name: "linux_libfuzzer_rel"
      mixins: "linux"
      recipe { name: "webrtc/libfuzzer" }
    }
    builders {
      name: "presubmit"
      mixins: "presubmit"
    }
    builders {
      name: "noop"
      mixins: "linux"
      recipe { name: "webrtc/noop" }
    }

    # Mac

    builders {
      name: "mac_chromium_compile"
      mixins: "mac_chromium"
    }
    builders { mixins: "mac"  name: "mac_compile_dbg" }
    builders { mixins: "mac"  name: "mac_compile_rel" }
    builders { mixins: "mac"  name: "mac_dbg" }
    builders { mixins: "mac"  name: "mac_rel" }
    builders { mixins: "mac"  name: "mac_asan" }

    # Win

    builders {
      name: "win_chromium_compile"
      mixins: "win_chromium"
    }
    builders { mixins: "win"  name: "win_compile_dbg" }
    builders { mixins: "win"  name: "win_compile_rel" }
    builders { mixins: "win"  name: "win_compile_x64_dbg" }
    builders { mixins: "win"  name: "win_compile_x64_rel" }
    builders { mixins: "win"  name: "win_dbg" }
    builders { mixins: "win"  name: "win_rel" }
    builders { mixins: "win"  name: "win_x64_dbg" }
    builders { mixins: "win"  name: "win_x64_rel" }
    builders { mixins: "win"  name: "win_clang_dbg" }
    builders { mixins: "win"  name: "win_clang_rel" }
    builders { mixins: "win"  name: "win_x64_clang_dbg" }
    builders { mixins: "win"  name: "win_x64_clang_rel" }
    builders {
      name: "win_more_configs"
      mixins: "win"
      recipe { name: "webrtc/more_configs" }
    }
    builders { mixins: "win"  name: "win_asan" }
    builders { mixins: "win"  name: "win_x64_win8" }
    builders { mixins: "win"  name: "win_x64_win10" }
  }
}

buckets {
  name: "master.chromium.webrtc"
  acl_sets: "waterfall"
}

buckets {
  name: "master.chromium.webrtc.fyi"
  acl_sets: "waterfall"
}

buckets {
  name: "master.client.webrtc"
  acl_sets: "waterfall"
}

buckets {
  name: "master.client.webrtc.fyi"
  acl_sets: "waterfall"
}

buckets {
  name: "master.client.webrtc.perf"
  acl_sets: "waterfall"
}

buckets {
  name: "master.tryserver.webrtc"
  acl_sets: "tryserver"
}
